<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog/1.9"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog/1.9
                  http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-1.9.xsd">
	<changeSet id="openhmis.inventory-v1.0-1" author="ibewes">
		<createTable tableName="inv_item">
			<column name="item_id" autoIncrement="true" type="int">
				<constraints nullable="false" primaryKey="true"/>
			</column>

			<column name="name" type="varchar(255)" defaultValue="" ><constraints nullable="false"/></column>
			<column name="description" type="varchar(1024)" defaultValue=""/>
			<column name="department_id" type="int"><constraints nullable="false" /></column>
			<column name="category_id" type="int" />
			<column name="default_price_id" type="int" />
			<column name="has_expiration" type="BOOLEAN" defaultValueBoolean="false" ><constraints nullable="false"/></column>
			<column name="concept_id" type="int" />
			<column name="drug_id" type="int" />

			<column name="creator" type="int" defaultValueNumeric="0" ><constraints nullable="false"/></column>
			<column name="date_created" type="DATETIME"><constraints nullable="false"/></column>
			<column name="changed_by" type="int"/>
			<column name="date_changed" type="DATETIME"/>
			<column defaultValueBoolean="false" name="retired" type="BOOLEAN"><constraints nullable="false"/></column>
			<column name="retired_by" type="int"/>
			<column name="date_retired" type="DATETIME"/>
			<column name="retire_reason" type="varchar(255)"/>
			<column name="uuid" type="char(38)"><constraints nullable="false" unique="true" /></column>
		</createTable>
		<createTable tableName="inv_item_attribute_type">
			<column name="item_attribute_type_id" type="int" autoIncrement="true">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="name" type="varchar(255)"><constraints nullable="false" /></column>
			<column name="description" type="varchar(1024)" />
			<column name="datatype" type="varchar(255)" />
			<column name="datatype_config" type="text" />
			<column name="preferred_handler" type="varchar(255)" />
			<column name="handler_config" type="text" />
			<column name="min_occurs" type="int"><constraints nullable="false" /></column>
			<column name="max_occurs" type="int"/>
			<column name="creator" type="int"><constraints nullable="false" /></column>
			<column name="date_created" type="datetime"><constraints nullable="false" /></column>
			<column name="changed_by" type="int" />
			<column name="date_changed" type="datetime" />
			<column name="retired" type="boolean" defaultValueBoolean="false"><constraints nullable="false" /></column>
			<column name="retired_by" type="int" />
			<column name="date_retired" type="datetime" />
			<column name="retire_reason" type="varchar(255)" defaultValue="null" />
			<column name="uuid" type="char(38)"><constraints nullable="false" unique="true" /></column>
		</createTable>
		<createTable tableName="inv_item_attribute">
			<column name="item_attribute_id" type="int" autoIncrement="true">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="item_id" type="int"><constraints nullable="false" /></column>
			<column name="item_attribute_type_id" type="int"><constraints nullable="false" /></column>
			<column name="value_reference" type="text"><constraints nullable="false" /></column>
			<column name="creator" type="int"><constraints nullable="false"/></column>
			<column name="date_created" type="datetime"><constraints nullable="false"/></column>
			<column name="changed_by" type="int"/>
			<column name="date_changed" type="datetime" />
			<column name="voided" type="boolean" defaultValueBoolean="false"><constraints nullable="false"/></column>
			<column name="voided_by" type="int" />
			<column name="date_voided" type="datetime" />
			<column name="void_reason" type="varchar(255)" defaultValue="null"/>
			<column name="uuid" type="char(38)"><constraints nullable="false" unique="true" /></column>
		</createTable>
		<createTable tableName="inv_item_price">
			<column name="item_price_id" autoIncrement="true" type="int">
				<constraints nullable="false" primaryKey="true" />
			</column>
			<column name="item_id" type="int"><constraints nullable="false"/></column>
			<column name="price" type="decimal(10,2)"><constraints nullable="false"/></column>

			<column defaultValue="" name="name" type="varchar(255)" />
			<column defaultValue="" name="description" type="varchar(1024)" />

			<column name="creator" type="int" defaultValueNumeric="0" ><constraints nullable="false"/></column>
			<column name="date_created" type="DATETIME"><constraints nullable="false"/></column>
			<column name="changed_by" type="int"/>
			<column name="date_changed" type="DATETIME"/>
			<column defaultValueBoolean="false" name="retired" type="BOOLEAN"><constraints nullable="false"/></column>
			<column name="retired_by" type="int"/>
			<column name="date_retired" type="DATETIME"/>
			<column name="retire_reason" type="varchar(255)"/>
			<column name="uuid" type="char(38)"><constraints nullable="false" unique="true" /></column>
		</createTable>
		<createTable tableName="inv_item_code">
			<column name="item_code_id" autoIncrement="true" type="int">
				<constraints nullable="false" primaryKey="true" />
			</column>
			<column name="item_id" type="int">
				<constraints nullable="false"/>
			</column>
			<column name="code" type="varchar(255)">
				<constraints nullable="false"/>
			</column>

			<column defaultValue="" name="name" type="varchar(255)" />
			<column defaultValue="" name="description" type="varchar(1024)" />

			<column name="creator" type="int" defaultValueNumeric="0" >
				<constraints nullable="false"/>
			</column>
			<column name="date_created" type="DATETIME">
				<constraints nullable="false"/>
			</column>
			<column name="changed_by" type="int"/>
			<column name="date_changed" type="DATETIME"/>
			<column defaultValueBoolean="false" name="retired" type="BOOLEAN">
				<constraints nullable="false"/>
			</column>
			<column name="retired_by" type="int"/>
			<column name="date_retired" type="DATETIME"/>
			<column name="retire_reason" type="varchar(255)"/>
			<column name="uuid" type="char(38)"><constraints nullable="false" unique="true" /></column>
		</createTable>
		<createTable tableName="inv_department">
			<column name="department_id" autoIncrement="true" type="int">
				<constraints nullable="false" primaryKey="true"/>
			</column>
			<column defaultValue="" name="name" type="varchar(255)"><constraints nullable="false"/></column>
			<column defaultValue="" name="description" type="varchar(1024)" />

			<column name="creator" type="int" defaultValueNumeric="0" >
				<constraints nullable="false"/>
			</column>
			<column name="date_created" type="DATETIME">
				<constraints nullable="false"/>
			</column>
			<column name="changed_by" type="int"/>
			<column name="date_changed" type="DATETIME"/>
			<column defaultValueBoolean="false" name="retired" type="BOOLEAN">
				<constraints nullable="false"/>
			</column>
			<column name="retired_by" type="int"/>
			<column name="date_retired" type="DATETIME"/>
			<column name="retire_reason" type="varchar(255)"/>
			<column name="uuid" type="char(38)"><constraints nullable="false" unique="true" /></column>
		</createTable>
		<createTable tableName="inv_category">
			<column name="category_id" autoIncrement="true" type="int">
				<constraints nullable="false" primaryKey="true"/>
			</column>
			<column defaultValue="" name="name" type="varchar(255)"><constraints nullable="false"/></column>
			<column defaultValue="" name="description" type="varchar(1024)" />
			<column name="parent_id" type="int" />

			<column name="creator" type="int" defaultValueNumeric="0" >
				<constraints nullable="false"/>
			</column>
			<column name="date_created" type="DATETIME">
				<constraints nullable="false"/>
			</column>
			<column name="changed_by" type="int"/>
			<column name="date_changed" type="DATETIME"/>
			<column defaultValueBoolean="false" name="retired" type="BOOLEAN">
				<constraints nullable="false"/>
			</column>
			<column name="retired_by" type="int"/>
			<column name="date_retired" type="DATETIME"/>
			<column name="retire_reason" type="varchar(255)"/>
			<column name="uuid" type="char(38)"><constraints nullable="false" unique="true" /></column>
		</createTable>
		<createTable tableName="inv_stockroom">
			<column name="stockroom_id" autoIncrement="true" type="int">
				<constraints nullable="false" primaryKey="true"/>
			</column>
			<column defaultValue="" name="name" type="varchar(255)"><constraints nullable="false"/></column>
			<column defaultValue="" name="description" type="varchar(1024)" />
			<column name="location_id" type="int" />

			<column name="creator" type="int" defaultValueNumeric="0" >
				<constraints nullable="false"/>
			</column>
			<column name="date_created" type="DATETIME">
				<constraints nullable="false"/>
			</column>
			<column name="changed_by" type="int"/>
			<column name="date_changed" type="DATETIME"/>
			<column defaultValueBoolean="false" name="retired" type="BOOLEAN">
				<constraints nullable="false"/>
			</column>
			<column name="retired_by" type="int"/>
			<column name="date_retired" type="DATETIME"/>
			<column name="retire_reason" type="varchar(255)"/>
			<column name="uuid" type="char(38)"><constraints nullable="false" unique="true" /></column>
		</createTable>
		<createTable tableName="inv_stockroom_item">
			<column name="stockroom_item_id" autoIncrement="true" type="int">
				<constraints nullable="false" primaryKey="true"/>
			</column>
			<column name="stockroom_id" type="int"><constraints nullable="false" /></column>
			<column name="batch_operation_id" type="int" />
			<column name="item_id" type="int"><constraints nullable="false" /></column>
			<column name="quantity" type="int"><constraints nullable="false"/></column>
			<column name="expiration" type="DATE" />
			<column name="uuid" type="char(38)"><constraints nullable="false" unique="true" /></column>
		</createTable>
		<createTable tableName="inv_stock_operation_type">
			<column name="stock_operation_type_id" autoIncrement="true" type="int">
				<constraints nullable="false" primaryKey="true"/>
			</column>

			<column name="name" type="varchar(255)" defaultValue="" ><constraints nullable="false"/></column>
			<column name="description" type="varchar(1024)" defaultValue=""/>

			<column name="operation_type" type="varchar(255)"><constraints nullable="false" /></column>

			<column name="has_source" type="boolean" />
			<column name="has_destination" type="boolean" />
			<column name="has_recipient" type="boolean" />
			<column name="recipient_required" type="boolean" />
			<column name="available_when_reserved" type="boolean"/>
			<column name="user_id" type="int" />
			<column name="role" type="varchar(50)" />

			<column name="creator" type="int" defaultValueNumeric="0" ><constraints nullable="false"/></column>
			<column name="date_created" type="DATETIME"><constraints nullable="false"/></column>
			<column name="changed_by" type="int"/>
			<column name="date_changed" type="DATETIME"/>
			<column defaultValueBoolean="false" name="retired" type="BOOLEAN"><constraints nullable="false"/></column>
			<column name="retired_by" type="int"/>
			<column name="date_retired" type="DATETIME"/>
			<column name="retire_reason" type="varchar(255)"/>
			<column name="uuid" type="char(38)"><constraints nullable="false" unique="true" /></column>
		</createTable>
		<createTable tableName="inv_stock_operation_attribute_type">
			<column name="stock_operation_attribute_type_id" autoIncrement="true" type="int">
				<constraints nullable="false" primaryKey="true"/>
			</column>
			<column defaultValue="" name="name" type="varchar(255)"><constraints nullable="false"/></column>
			<column defaultValue="" name="description" type="varchar(1024)" />

			<column name="operation_type_id" type="int"><constraints nullable="false"/></column>
			<column name="attribute_order" type="int"><constraints nullable="false" /></column>
			<column name="format" type="varchar(255)" />
			<column name="foreign_key" type="int" />
			<column name="reg_exp" type="varchar(255)" />
			<column name="required" type="boolean" defaultValueBoolean="false" />

			<column name="creator" type="int" defaultValueNumeric="0"><constraints nullable="false"/></column>
			<column name="date_created" type="DATETIME"><constraints nullable="false"/></column>
			<column name="changed_by" type="int"/>
			<column name="date_changed" type="DATETIME"/>
			<column defaultValueBoolean="false" name="retired" type="BOOLEAN"><constraints nullable="false"/></column>
			<column name="retired_by" type="int"/>
			<column name="date_retired" type="DATETIME"/>
			<column name="retire_reason" type="varchar(255)"/>
			<column name="uuid" type="char(38)"><constraints nullable="false" unique="true" /></column>
		</createTable>
		<createTable tableName="inv_stock_operation">
			<column name="stock_operation_id" autoIncrement="true" type="int">
				<constraints nullable="false" primaryKey="true"/>
			</column>

			<column name="operation_type_id" type="int"><constraints nullable="false" /></column>
			<column name="status" type="varchar(50)"><constraints nullable="false" /></column>
			<column name="name" type="varchar(255)" />
			<column name="description" type="varchar(1024)" />
			<column name="operation_number" type="varchar(255)" />
			<column name="source_id" type="int" />
			<column name="destination_id" type="int" />
			<column name="recipient_id" type="int" />

			<column name="creator" type="int" defaultValueNumeric="0" ><constraints nullable="false"/></column>
			<column name="date_created" type="DATETIME"><constraints nullable="false"/></column>
			<column name="changed_by" type="int"/>
			<column name="date_changed" type="DATETIME"/>
			<column defaultValueBoolean="false" name="retired" type="BOOLEAN"><constraints nullable="false"/></column>
			<column name="retired_by" type="int"/>
			<column name="date_retired" type="DATETIME"/>
			<column name="retire_reason" type="varchar(255)"/>
			<column name="uuid" type="char(38)"><constraints nullable="false" unique="true" /></column>
		</createTable>
		<createTable tableName="inv_stock_operation_attribute">
			<column name="stock_operation_attribute_id" autoIncrement="true" type="int">
				<constraints nullable="false" primaryKey="true"/>
			</column>
			<column name="operation_id" type="int"><constraints nullable="false" /></column>
			<column name="attribute_type_id" type="int"><constraints nullable="false" /></column>
			<column name="value_reference" type="text"><constraints nullable="false" /></column>

			<column name="uuid" type="char(38)"><constraints nullable="false" unique="true" /></column>
		</createTable>
		<createTable tableName="inv_transaction">
			<column name="transaction_id" autoIncrement="true" type="int">
				<constraints nullable="false" primaryKey="true"/>
			</column>

			<column name="operation_id" type="int"><constraints nullable="false" /></column>
			<column name="item_id" type="int"><constraints nullable="false" /></column>
			<column name="quantity" type="int"><constraints nullable="false"/></column>
			<column name="expiration" type="DATE" />

			<column name="stockroom_id" type="int" />
			<column name="recipient_id" type="int" />

			<column name="creator" type="int" defaultValueNumeric="0" ><constraints nullable="false"/></column>
			<column name="date_created" type="DATETIME"><constraints nullable="false"/></column>
			<column name="uuid" type="char(38)"><constraints nullable="false" unique="true" /></column>
		</createTable>
		<createTable tableName="inv_reserved_transaction">
			<column name="reserved_transaction_id" autoIncrement="true" type="int">
				<constraints nullable="false" primaryKey="true"/>
			</column>

			<column name="operation_id" type="int"><constraints nullable="false" /></column>
			<column name="item_id" type="int"><constraints nullable="false" /></column>
			<column name="quantity" type="int"><constraints nullable="false"/></column>
			<column name="expiration" type="DATE" />

			<column defaultValueBoolean="true" name="is_available" type="BOOLEAN"><constraints nullable="false"/></column>

			<column name="creator" type="int" defaultValueNumeric="0" ><constraints nullable="false"/></column>
			<column name="date_created" type="DATETIME"><constraints nullable="false"/></column>
			<column name="uuid" type="char(38)"><constraints nullable="false" unique="true" /></column>
		</createTable>
		<createTable tableName="inv_stockroom_operations">
			<column name="stockroom_id" type="int"><constraints nullable="false" primaryKey="true" /></column>
			<column name="operation_id" type="int"><constraints nullable="false" primaryKey="true" /></column>
		</createTable>

		<createTable tableName="inv_institution">
            <column name="institution_id" autoIncrement="true" type="int">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column defaultValue="" name="name" type="varchar(255)"><constraints nullable="false"/></column>
            <column defaultValue="" name="description" type="varchar(1024)" />

            <column name="creator" type="int" defaultValueNumeric="0" >
                <constraints nullable="false"/>
            </column>
            <column name="date_created" type="DATETIME">
                <constraints nullable="false"/>
            </column>
            <column name="changed_by" type="int"/>
            <column name="date_changed" type="DATETIME"/>
            <column defaultValueBoolean="false" name="retired" type="BOOLEAN">
                <constraints nullable="false"/>
            </column>
            <column name="retired_by" type="int"/>
            <column name="date_retired" type="DATETIME"/>
            <column name="retire_reason" type="varchar(255)"/>
            <column name="uuid" type="char(38)"><constraints nullable="false" unique="true" /></column>
        </createTable>
        <createTable tableName="inv_recipient">
            <column name="recipient_id" type="int"><constraints nullable="false" /></column>
            <column name="patient_id" type="int"><constraints nullable="false" /></column>
            <column name="institution_id" type="int" />

            <column name="creator" type="int" defaultValueNumeric="0" ><constraints nullable="false"/></column>
            <column name="date_created" type="DATETIME"><constraints nullable="false"/></column>
            <column name="changed_by" type="int"/>
            <column name="date_changed" type="DATETIME"/>
            <column defaultValueBoolean="false" name="retired" type="BOOLEAN"><constraints nullable="false"/></column>
            <column name="retired_by" type="int"/>
            <column name="date_retired" type="DATETIME"/>
            <column name="retire_reason" type="varchar(255)"/>
            <column name="uuid" type="char(38)"><constraints nullable="false" unique="true" /></column>
        </createTable>

		<createIndex indexName="inv_item_name_idx" tableName="inv_item" unique="false">
			<column name="name"/>
			<column name="retired" />
		</createIndex>
		<createIndex indexName="inv_item_department_name_idx" tableName="inv_item" unique="false">
			<column name="department_id" />
			<column name="name"/>
			<column name="retired" />
		</createIndex>
		<createIndex indexName="inv_item_category_name_idx" tableName="inv_item" unique="false">
			<column name="category_id" />
			<column name="name"/>
			<column name="retired" />
		</createIndex>
		<createIndex indexName="inv_category_parent_idx" tableName="inv_category" unique="false">
			<column name="parent_id"/>
			<column name="retired" />
		</createIndex>
		<createIndex indexName="inv_stockroom_item_item_idx" tableName="inv_stockroom_item" unique="true">
			<column name="stockroom_id"/>
			<column name="item_id" />
		</createIndex>
		<createIndex indexName="inv_stock_operation_attribute_type_idx" tableName="inv_stock_operation_attribute_type" unique="false">
			<column name="operation_type_id"/>
			<column name="attribute_order" />
		</createIndex>
		<createIndex indexName="inv_stock_operation_attribute_idx" tableName="inv_stock_operation_attribute" unique="false">
			<column name="operation_id"/>
			<column name="attribute_type_id" />
		</createIndex>
		<createIndex indexName="inv_recipient_idx" tableName="inv_recipient" unique="false">
            <column name="recipient_id" />
            <column name="retired" />
        </createIndex>

		<addForeignKeyConstraint constraintName="inv_item_creator_fk"
	                             baseTableName="inv_item" baseColumnNames="creator"
		                         referencedTableName="users" referencedColumnNames="user_id"
		                         deferrable="false" initiallyDeferred="false" />
		<addForeignKeyConstraint constraintName="inv_item_changed_by_fk"
		                         baseTableName="inv_item" baseColumnNames="changed_by"
		                         referencedTableName="users" referencedColumnNames="user_id"
		                         deferrable="false" initiallyDeferred="false" />
		<addForeignKeyConstraint constraintName="inv_item_retired_by_fk"
		                         baseTableName="inv_item" baseColumnNames="retired_by"
		                         referencedTableName="users" referencedColumnNames="user_id"
		                         deferrable="false" initiallyDeferred="false" />
		<addForeignKeyConstraint constraintName="inv_item_department_fk"
		                         baseTableName="inv_item" baseColumnNames="department_id"
		                         referencedTableName="inv_department" referencedColumnNames="department_id"
		                         deferrable="false" initiallyDeferred="false" />
		<addForeignKeyConstraint constraintName="inv_item_category_fk"
		                         baseTableName="inv_item" baseColumnNames="category_id"
		                         referencedTableName="inv_category" referencedColumnNames="category_id"
		                         deferrable="false" initiallyDeferred="false" />
		<addForeignKeyConstraint constraintName="inv_item_concept_id_fk"
		                         baseTableName="inv_item" baseColumnNames="concept_id"
		                         referencedTableName="concept" referencedColumnNames="concept_id"/>
		<addForeignKeyConstraint constraintName="inv_item_drug_id_fk"
		                         baseTableName="inv_item" baseColumnNames="drug_id"
		                         referencedTableName="drug" referencedColumnNames="drug_id"/>

		<addForeignKeyConstraint constraintName="inv_item_attribute_type_creator_fk"
		                         baseTableName="inv_item_attribute_type" baseColumnNames="creator"
		                         referencedTableName="users" referencedColumnNames="user_id"/>
		<addForeignKeyConstraint constraintName="inv_item_attribute_type_changed_by_fk"
		                         baseTableName="inv_item_attribute_type" baseColumnNames="changed_by"
		                         referencedTableName="users" referencedColumnNames="user_id"/>
		<addForeignKeyConstraint constraintName="inv_item_attribute_type_retired_by_fk"
		                         baseTableName="inv_item_attribute_type" baseColumnNames="retired_by"
		                         referencedTableName="users" referencedColumnNames="user_id"/>

		<addForeignKeyConstraint constraintName="inv_item_attribute_attribute_type_id_fk"
		                         baseTableName="inv_item_attribute" baseColumnNames="item_attribute_type_id"
		                         referencedTableName="inv_item_attribute_type" referencedColumnNames="item_attribute_type_id" />
		<addForeignKeyConstraint constraintName="inv_item_attribute_item_id_fk"
		                         baseTableName="inv_item_attribute" baseColumnNames="item_id"
		                         referencedTableName="inv_item" referencedColumnNames="item_id"
		                         onDelete="CASCADE" onUpdate="CASCADE"/>
		<addForeignKeyConstraint constraintName="inv_item_attribute_creator_fk"
		                         baseTableName="inv_item_attribute" baseColumnNames="creator"
		                         referencedTableName="users" referencedColumnNames="user_id"/>
		<addForeignKeyConstraint constraintName="inv_item_attribute_changed_by_fk"
		                         baseTableName="inv_item_attribute" baseColumnNames="changed_by"
		                         referencedTableName="users" referencedColumnNames="user_id"/>
		<addForeignKeyConstraint constraintName="inv_item_attribute_voided_by_fk"
		                         baseTableName="inv_item_attribute" baseColumnNames="voided_by"
		                         referencedTableName="users" referencedColumnNames="user_id"/>

		<addForeignKeyConstraint constraintName="inv_item_price_item_id_fk"
		                         baseTableName="inv_item_price" baseColumnNames="item_id"
		                         referencedTableName="inv_item" referencedColumnNames="item_id"
		                         onDelete="CASCADE" onUpdate="CASCADE"/>
		<addForeignKeyConstraint constraintName="inv_item_price_creator_fk"
		                         baseTableName="inv_item_price" baseColumnNames="creator"
		                         referencedTableName="users" referencedColumnNames="user_id"/>
		<addForeignKeyConstraint constraintName="inv_item_price_changed_by_fk"
		                         baseTableName="inv_item_price" baseColumnNames="changed_by"
		                         referencedTableName="users" referencedColumnNames="user_id"/>
		<addForeignKeyConstraint constraintName="inv_item_price_retired_by_fk"
		                         baseTableName="inv_item_price" baseColumnNames="retired_by"
		                         referencedTableName="users" referencedColumnNames="user_id"/>

		<addForeignKeyConstraint constraintName="inv_item_code_item_id_fk"
		                         baseTableName="inv_item_code" baseColumnNames="item_id"
		                         referencedTableName="inv_item" referencedColumnNames="item_id"
		                         onDelete="CASCADE" onUpdate="CASCADE" />
		<addForeignKeyConstraint constraintName="inv_item_code_creator_fk"
		                         baseTableName="inv_item_code" baseColumnNames="creator"
		                         referencedTableName="users" referencedColumnNames="user_id"/>
		<addForeignKeyConstraint constraintName="inv_item_code_changed_by_fk"
		                         baseTableName="inv_item_code" baseColumnNames="changed_by"
		                         referencedTableName="users" referencedColumnNames="user_id"/>
		<addForeignKeyConstraint constraintName="inv_item_code_retired_by_fk"
		                         baseTableName="inv_item_code" baseColumnNames="retired_by"
		                         referencedTableName="users" referencedColumnNames="user_id"/>

		<addForeignKeyConstraint constraintName="inv_department_creator_fk"
		                         baseTableName="inv_department" baseColumnNames="creator"
		                         referencedTableName="users" referencedColumnNames="user_id"/>
		<addForeignKeyConstraint constraintName="inv_department_changed_by_fk"
		                         baseTableName="inv_department" baseColumnNames="changed_by"
		                         referencedTableName="users" referencedColumnNames="user_id"/>
		<addForeignKeyConstraint constraintName="inv_department_retired_by_fk"
		                         baseTableName="inv_department" baseColumnNames="retired_by"
		                         referencedTableName="users" referencedColumnNames="user_id"/>

		<addForeignKeyConstraint constraintName="inv_category_creator_fk"
		                         baseTableName="inv_category" baseColumnNames="creator"
		                         referencedTableName="users" referencedColumnNames="user_id"/>
		<addForeignKeyConstraint constraintName="inv_category_changed_by_fk"
		                         baseTableName="inv_category" baseColumnNames="changed_by"
		                         referencedTableName="users" referencedColumnNames="user_id"/>
		<addForeignKeyConstraint constraintName="inv_category_retired_by_fk"
		                         baseTableName="inv_category" baseColumnNames="retired_by"
		                         referencedTableName="users" referencedColumnNames="user_id"/>
		<addForeignKeyConstraint constraintName="inv_category_parent_fk"
		                         baseTableName="inv_category" baseColumnNames="parent_id"
		                         referencedTableName="inv_category" referencedColumnNames="category_id"
		                         onDelete="CASCADE" onUpdate="CASCADE"/>

		<addForeignKeyConstraint constraintName="inv_stockroom_location_fk"
		                         baseTableName="inv_stockroom" baseColumnNames="location_id"
		                         referencedTableName="location" referencedColumnNames="location_id"/>
		<addForeignKeyConstraint constraintName="inv_stockroom_creator_fk"
		                         baseTableName="inv_stockroom" baseColumnNames="creator"
		                         referencedTableName="users" referencedColumnNames="user_id"/>
		<addForeignKeyConstraint constraintName="inv_stockroom_changed_by_fk"
		                         baseTableName="inv_stockroom" baseColumnNames="changed_by"
		                         referencedTableName="users" referencedColumnNames="user_id"/>
		<addForeignKeyConstraint constraintName="inv_stockroom_retired_by_fk"
		                         baseTableName="inv_stockroom" baseColumnNames="retired_by"
		                         referencedTableName="users" referencedColumnNames="user_id"/>

		<addForeignKeyConstraint constraintName="inv_stockroom_item_stockroom_fk"
		                         baseTableName="inv_stockroom_item" baseColumnNames="stockroom_id"
		                         referencedTableName="inv_stockroom" referencedColumnNames="stockroom_id"/>
		<addForeignKeyConstraint constraintName="inv_stockroom_item_item_fk"
		                         baseTableName="inv_stockroom_item" baseColumnNames="item_id"
		                         referencedTableName="inv_item" referencedColumnNames="item_id"/>
		<addForeignKeyConstraint constraintName="inv_stockroom_item_batch_operation_fk"
		                         baseTableName="inv_stockroom_item" baseColumnNames="batch_operation_id"
		                         referencedTableName="inv_stock_operation" referencedColumnNames="stock_operation_id"/>

		<addForeignKeyConstraint constraintName="inv_stock_operation_operation_type_fk"
		                         baseTableName="inv_stock_operation" baseColumnNames="operation_type_id"
		                         referencedTableName="inv_stock_operation_type" referencedColumnNames="stock_operation_type_id"/>
		<addForeignKeyConstraint constraintName="inv_stock_operation_source_fk"
		                         baseTableName="inv_stock_operation" baseColumnNames="source_id"
		                         referencedTableName="inv_stockroom" referencedColumnNames="stockroom_id"/>
		<addForeignKeyConstraint constraintName="inv_stock_operation_destination_fk"
		                         baseTableName="inv_stock_operation" baseColumnNames="destination_id"
		                         referencedTableName="inv_stockroom" referencedColumnNames="stockroom_id"/>
		<addForeignKeyConstraint constraintName="inv_stock_operation_recipient_id_fk"
		                         baseTableName="inv_stock_operation" baseColumnNames="recipient_id"
		                         referencedTableName="inv_recipient" referencedColumnNames="recipient_id"/>
		<addForeignKeyConstraint constraintName="inv_stock_operation_creator_fk"
		                         baseTableName="inv_stock_operation" baseColumnNames="creator"
		                         referencedTableName="users" referencedColumnNames="user_id"/>
		<addForeignKeyConstraint constraintName="inv_stock_operation_changed_by_fk"
		                         baseTableName="inv_stock_operation" baseColumnNames="changed_by"
		                         referencedTableName="users" referencedColumnNames="user_id"/>
		<addForeignKeyConstraint constraintName="inv_stock_operation_retired_by_fk"
		                         baseTableName="inv_stock_operation" baseColumnNames="retired_by"
		                         referencedTableName="users" referencedColumnNames="user_id"/>

		<addForeignKeyConstraint constraintName="inv_reserved_transaction_operation_fk"
		                         baseTableName="inv_reserved_transaction" baseColumnNames="operation_id"
		                         referencedTableName="inv_stock_operation" referencedColumnNames="stock_operation_id"/>
		<addForeignKeyConstraint constraintName="inv_reserved_transaction_item_fk"
		                         baseTableName="inv_reserved_transaction" baseColumnNames="item_id"
		                         referencedTableName="inv_item" referencedColumnNames="item_id"/>
		<addForeignKeyConstraint constraintName="inv_reserved_transaction_creator_fk"
		                         baseTableName="inv_reserved_transaction" baseColumnNames="creator"
		                         referencedTableName="users" referencedColumnNames="user_id"/>

		<addForeignKeyConstraint constraintName="inv_transaction_operation_fk"
		                         baseTableName="inv_transaction" baseColumnNames="operation_id"
		                         referencedTableName="inv_stock_operation" referencedColumnNames="stock_operation_id"/>
		<addForeignKeyConstraint constraintName="inv_transaction_item_fk"
		                         baseTableName="inv_transaction" baseColumnNames="item_id"
		                         referencedTableName="inv_item" referencedColumnNames="item_id"/>
		<addForeignKeyConstraint constraintName="inv_transaction_creator_fk"
		                         baseTableName="inv_transaction" baseColumnNames="creator"
		                         referencedTableName="users" referencedColumnNames="user_id"/>

		<addForeignKeyConstraint constraintName="inv_stock_operation_type_creator_fk"
		                         baseTableName="inv_stock_operation_type" baseColumnNames="creator"
		                         referencedTableName="users" referencedColumnNames="user_id"/>
		<addForeignKeyConstraint constraintName="inv_stock_operation_type_changed_by_fk"
		                         baseTableName="inv_stock_operation_type" baseColumnNames="changed_by"
		                         referencedTableName="users" referencedColumnNames="user_id"/>
		<addForeignKeyConstraint constraintName="inv_stock_operation_type_retired_by_fk"
		                         baseTableName="inv_stock_operation_type" baseColumnNames="retired_by"
		                         referencedTableName="users" referencedColumnNames="user_id"/>
		<addForeignKeyConstraint constraintName="inv_stock_operation_type_user_id_fk"
		                         baseTableName="inv_stock_operation_type" baseColumnNames="user_id"
		                         referencedTableName="users" referencedColumnNames="user_id"/>
		<addForeignKeyConstraint constraintName="inv_stock_operation_type_role_fk"
		                         baseTableName="inv_stock_operation_type" baseColumnNames="role"
		                         referencedTableName="role" referencedColumnNames="role"/>

		<addForeignKeyConstraint constraintName="inv_st_op_attr_type_operation_type_fk"
		                         baseTableName="inv_stock_operation_attribute_type" baseColumnNames="operation_type_id"
		                         referencedTableName="inv_stock_operation_type" referencedColumnNames="stock_operation_type_id"/>
		<addForeignKeyConstraint constraintName="inv_st_op_attr_type_creator_fk"
		                         baseTableName="inv_stock_operation_attribute_type" baseColumnNames="creator"
		                         referencedTableName="users" referencedColumnNames="user_id"/>
		<addForeignKeyConstraint constraintName="inv_st_op_attr_type_changed_by_fk"
		                         baseTableName="inv_stock_operation_attribute_type" baseColumnNames="changed_by"
		                         referencedTableName="users" referencedColumnNames="user_id"/>
		<addForeignKeyConstraint constraintName="inv_st_op_attr_type_retired_by_fk"
		                         baseTableName="inv_stock_operation_attribute_type" baseColumnNames="retired_by"
		                         referencedTableName="users" referencedColumnNames="user_id"/>

		<addForeignKeyConstraint constraintName="inv_stock_operation_attribute_operation_fk"
		                         baseTableName="inv_stock_operation_attribute" baseColumnNames="operation_id"
		                         referencedTableName="inv_stock_operation" referencedColumnNames="stock_operation_id"/>
		<addForeignKeyConstraint constraintName="inv_stock_operation_attribute_attribute_type_fk"
		                         baseTableName="inv_stock_operation_attribute" baseColumnNames="attribute_type_id"
		                         referencedTableName="inv_stock_operation_attribute_type" referencedColumnNames="stock_operation_attribute_type_id"/>

		<addForeignKeyConstraint constraintName="inv_stock_operations_stockroom_fk"
		                         baseTableName="inv_stockroom_operations" baseColumnNames="stockroom_id"
		                         referencedTableName="inv_stockroom" referencedColumnNames="stockroom_id"/>
		<addForeignKeyConstraint constraintName="inv_stock_operations_operation_fk"
		                         baseTableName="inv_stockroom_operations" baseColumnNames="operation_id"
		                         referencedTableName="inv_stock_operation" referencedColumnNames="stock_operation_id"/>

		<addForeignKeyConstraint constraintName="inv_institution_creator_fk"
                                 baseTableName="inv_institution" baseColumnNames="creator"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
        <addForeignKeyConstraint constraintName="inv_institution_changed_by_fk"
                                 baseTableName="inv_institution" baseColumnNames="changed_by"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
        <addForeignKeyConstraint constraintName="inv_institution_retired_by_fk"
                                 baseTableName="inv_institution" baseColumnNames="retired_by"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
        <addForeignKeyConstraint constraintName="inv_recipient_patient_fk"
                                 baseTableName="inv_recipient" baseColumnNames="patient_id"
                                 referencedTableName="patient" referencedColumnNames="patient_id"/>
        <addForeignKeyConstraint constraintName="inv_recipient_institution_fk"
                                 baseTableName="inv_recipient" baseColumnNames="institution_id"
                                 referencedTableName="inv_institution" referencedColumnNames="institution_id"/>

		<insert tableName="inv_stock_operation_type">
			<column name="name">Adjustment</column>
			<column name="operation_type">adjustment</column>
			<column name="description">Physical item quantities that do not match the current system quantity.</column>
			<column name="has_source">1</column>
			<column name="has_destination">0</column>
			<column name="has_recipient">0</column>
			<column name="recipient_required">0</column>
			<column name="available_when_reserved">1</column>
			<column name="creator">1</column>
			<column name="date_created">2013-01-01</column>
			<column name="uuid">288fd7fe-1374-4f7a-89e6-d5f1ac97d4a5</column>
		</insert>
		<insert tableName="inv_stock_operation_type">
			<column name="name">Disposed</column>
			<column name="operation_type">disposed</column>
			<column name="description">Item stock quantities that have expired and must be removed from circulation.</column>
			<column name="has_source">1</column>
			<column name="has_destination">0</column>
			<column name="has_recipient">0</column>
			<column name="recipient_required">0</column>
			<column name="available_when_reserved">1</column>
			<column name="creator">1</column>
			<column name="date_created">2013-01-01</column>
			<column name="uuid">84be0aaf-70cf-4ebb-83e3-088e5d375905</column>
		</insert>
		<insert tableName="inv_stock_operation_type">
			<column name="name">Distribution</column>
			<column name="operation_type">distribution</column>
			<column name="description">Items that are distributed to a patient or other outside destination.</column>
			<column name="has_source">1</column>
			<column name="has_destination">0</column>
			<column name="has_recipient">1</column>
			<column name="recipient_required">0</column>
			<column name="available_when_reserved">0</column>
			<column name="creator">1</column>
			<column name="date_created">2013-01-01</column>
			<column name="uuid">c264f34b-c795-4576-9928-454d1fa20e09</column>
		</insert>
		<insert tableName="inv_stock_operation_type">
			<column name="name">Receipt</column>
			<column name="operation_type">receipt</column>
			<column name="description">Items that are added into the inventory system from an outside provider.</column>
			<column name="has_source">0</column>
			<column name="has_destination">1</column>
			<column name="has_recipient">0</column>
			<column name="recipient_required">0</column>
			<column name="available_when_reserved">0</column>
			<column name="creator">1</column>
			<column name="date_created">2013-01-01</column>
			<column name="uuid">fce0b4fc-9402-424a-aacb-f99599e51a9f</column>
		</insert>
		<insert tableName="inv_stock_operation_type">
			<column name="name">Return</column>
			<column name="operation_type">return</column>
			<column name="description">Items that are returned to the system after a Distribution operation.</column>
			<column name="has_source">0</column>
			<column name="has_destination">1</column>
			<column name="has_recipient">1</column>
			<column name="recipient_required">0</column>
			<column name="available_when_reserved">0</column>
			<column name="creator">1</column>
			<column name="date_created">2013-01-01</column>
			<column name="uuid">128924d7-72ee-414e-ae40-52f1f89d3e7d</column>
		</insert>
		<insert tableName="inv_stock_operation_type">
			<column name="name">Transfer</column>
			<column name="operation_type">transfer</column>
			<column name="description">Items that are transferred between two stockrooms.</column>
			<column name="has_source">1</column>
			<column name="has_destination">1</column>
			<column name="has_recipient">0</column>
			<column name="recipient_required">0</column>
			<column name="available_when_reserved">1</column>
			<column name="creator">1</column>
			<column name="date_created">2013-01-01</column>
			<column name="uuid">db40707f-9175-4199-8df2-a5702f41ec7d</column>
		</insert>
	</changeSet>
	<changeSet id="openhmis.inventory-v1.0.0-2" author="ibewes">
		<createTable tableName="inv_item_stock">
			<column name="item_stock_id" autoIncrement="true" type="int">
				<constraints nullable="false" primaryKey="true"/>
			</column>

			<column name="stockroom_id" type="int"><constraints nullable="false" /></column>
			<column name="item_id" type="int"><constraints nullable="false" /></column>
			<column name="quantity" type="int"><constraints nullable="false" /></column>
			<column name="uuid" type="char(38)"><constraints nullable="false" unique="true" /></column>
		</createTable>
		<createTable tableName="inv_item_stock_detail">
			<column name="item_stock_detail_id" autoIncrement="true" type="int">
				<constraints nullable="false" primaryKey="true"/>
			</column>

			<column name="stock_item_id" type="int"><constraints nullable="false" /></column>
			<column name="stockroom_id" type="int"><constraints nullable="false" /></column>
			<column name="item_id" type="int"><constraints nullable="false" /></column>
			<column name="expiration" type="DATETIME" />
			<column name="batch_operation_id" type="int" />
			<column name="quantity" type="int" />

			<column name="calculated_expiration" type="boolean" defaultValueBoolean="true">
				<constraints nullable="false" />
			</column>
			<column name="calculated_batch" type="boolean" defaultValueBoolean="true">
				<constraints nullable="false" />
			</column>

			<column name="uuid" type="char(38)"><constraints nullable="false" unique="true" /></column>
		</createTable>

		<createIndex tableName="inv_item_stock" indexName="inv_item_stock_item_stockroom_idx" unique="true">
			<column name="stockroom_id" />
			<column name="item_id" />
		</createIndex>
		<createIndex tableName="inv_item_stock_detail" indexName="inv_item_stock_detail_item_stockroom_idx" unique="false">
			<column name="stockroom_id" />
			<column name="item_id" />
		</createIndex>

		<addForeignKeyConstraint constraintName="inv_item_stock_stockroom_fk"
		                         baseTableName="inv_item_stock" baseColumnNames="stockroom_id"
		                         referencedTableName="inv_stockroom" referencedColumnNames="stockroom_id"/>
		<addForeignKeyConstraint constraintName="inv_item_stock_item_fk"
		                         baseTableName="inv_item_stock" baseColumnNames="item_id"
		                         referencedTableName="inv_item" referencedColumnNames="item_id"/>

		<addForeignKeyConstraint constraintName="inv_item_stock_detail_stockroom_fk"
		                         baseTableName="inv_item_stock" baseColumnNames="stockroom_id"
		                         referencedTableName="inv_stockroom" referencedColumnNames="stockroom_id"/>
		<addForeignKeyConstraint constraintName="inv_item_stock_detail_item_fk"
		                         baseTableName="inv_item_stock_detail" baseColumnNames="item_id"
		                         referencedTableName="inv_item" referencedColumnNames="item_id"/>
		<addForeignKeyConstraint constraintName="inv_item_stock_detail_batch_fk"
		                         baseTableName="inv_item_stock_detail" baseColumnNames="batch_operation_id"
		                         referencedTableName="inv_stock_operation" referencedColumnNames="stock_operation_id"/>

		<dropTable tableName="inv_stockroom_item" />

		<addColumn tableName="inv_transaction">
			<column name="batch_operation_id" type="int" />
		</addColumn>
		<addColumn tableName="inv_reserved_transaction">
			<column name="batch_operation_id" type="int" />
		</addColumn>

		<addForeignKeyConstraint constraintName="inv_transaction_batch_fk"
		                         baseTableName="inv_transaction" baseColumnNames="batch_operation_id"
		                         referencedTableName="inv_stock_operation" referencedColumnNames="stock_operation_id"/>
		<addForeignKeyConstraint constraintName="inv_reserved_transaction_fk"
		                         baseTableName="inv_reserved_transaction" baseColumnNames="batch_operation_id"
		                         referencedTableName="inv_stock_operation" referencedColumnNames="stock_operation_id"/>
	</changeSet>
	<changeSet id="openhmis.inventory-1.0.0-3" author="ibewes">
		<addColumn tableName="inv_transaction">
			<column name="calculated_expiration" type="boolean" defaultValueBoolean="true" />
			<column name="source_calculated_expiration" type="boolean" defaultValueBoolean="true" />
			<column name="calculated_batch" type="boolean" defaultValueBoolean="true" />
			<column name="source_calculated_batch" type="boolean" defaultValueBoolean="true" />
		</addColumn>

		<addColumn tableName="inv_reserved_transaction">
			<column name="calculated_expiration" type="boolean" defaultValueBoolean="true" />
			<column name="source_calculated_expiration" type="boolean" defaultValueBoolean="true" />
			<column name="calculated_batch" type="boolean" defaultValueBoolean="true" />
			<column name="source_calculated_batch" type="boolean" defaultValueBoolean="true" />
		</addColumn>

		<addColumn tableName="inv_stock_operation">
			<column name="operation_date" type="DATETIME"><constraints nullable="false" /></column>
		</addColumn>

		<modifyColumn tableName="inv_item_stock_detail">
			<column name="calculated_expiration" type="boolean" defaultValueBoolean="true" />
			<column name="calculated_batch" type="boolean" defaultValueBoolean="true" />
		</modifyColumn>
	</changeSet>
	<changeSet id="openhmis.inventory-v1.0.0-4" author="ibewes">
		<addColumn tableName="inv_item">
			<column name="has_physical_inventory" type="boolean" defaultValueBoolean="true"/>
		</addColumn>

		<renameColumn tableName="inv_item_stock_detail"
		              oldColumnName="stock_item_id" newColumnName="item_stock_id" columnDataType="int" />

		<addForeignKeyConstraint constraintName="inv_item_stock_detail_item_stock_fk"
		                         baseTableName="inv_item_stock_detail" baseColumnNames="item_stock_id"
		                         referencedTableName="inv_item_stock" referencedColumnNames="item_stock_id"/>
	</changeSet>
	<changeSet id="openhmis.inventory-v1.0.0-5" author="marios">
        <addColumn tableName="inv_item">
            <column name="default_expiration_period" type="int" />
        </addColumn>
    </changeSet>
    <changeSet id="openhmis.inventory-v1.0.0-6" author="ibewes">
        <dropColumn tableName="inv_transaction" columnName="recipient_id" />

        <addColumn tableName="inv_transaction">
            <column name="institution_id" type="int"><constraints nullable="true" /></column>
        </addColumn>
        <addColumn tableName="inv_transaction">
            <column name="patient_id" type="int"><constraints nullable="true" /></column>
        </addColumn>

        <addForeignKeyConstraint constraintName="inv_transaction_institution_fk"
                                 baseTableName="inv_transaction" baseColumnNames="institution_id"
                                 referencedTableName="inv_institution" referencedColumnNames="institution_id"/>
        <addForeignKeyConstraint constraintName="inv_transaction_patient_fk"
                                 baseTableName="inv_transaction" baseColumnNames="patient_id"
                                 referencedTableName="patient" referencedColumnNames="patient_id"/>
    </changeSet>
    <changeSet id="openhmis.inventory-v1.0.0-7" author="ibewes">
        <dropForeignKeyConstraint baseTableName="inv_stock_operation" constraintName="inv_stock_operation_recipient_id_fk" />
        <dropColumn tableName="inv_stock_operation" columnName="recipient_id" />

        <dropTable tableName="inv_recipient" />

        <addColumn tableName="inv_stock_operation">
            <column name="institution_id" type="int"><constraints nullable="true" /></column>
        </addColumn>
        <addColumn tableName="inv_stock_operation">
            <column name="patient_id" type="int"><constraints nullable="true" /></column>
        </addColumn>

        <addForeignKeyConstraint constraintName="inv_stock_operation_institution_fk"
                                 baseTableName="inv_stock_operation" baseColumnNames="institution_id"
                                 referencedTableName="inv_institution" referencedColumnNames="institution_id"/>
        <addForeignKeyConstraint constraintName="inv_stock_operation_patient_fk"
                                 baseTableName="inv_stock_operation" baseColumnNames="patient_id"
                                 referencedTableName="patient" referencedColumnNames="patient_id"/>
    </changeSet>
    <changeSet id="openhmis.inventory-v1.0.0-8" author="marios">
        <dropForeignKeyConstraint baseTableName="inv_item" constraintName="inv_item_drug_id_fk" />
        <dropColumn tableName="inv_item" columnName="drug_id" />
    </changeSet>
    <changeSet id="openhmis.inventory-v1.0.0-9" author="marios">
        <addColumn tableName="inv_item" >
            <column name="concept_accepted" type="boolean" defaultValueBoolean="false" />
        </addColumn>
    </changeSet>
	<changeSet id="openhmis.inventory-v1.0.0-10" author="ibewes">
		<createTable tableName="inv_stock_operation_item">
			<column name="stock_operation_item_id" autoIncrement="true" type="int">
				<constraints nullable="false" primaryKey="true"/>
			</column>

			<column name="operation_id" type="int"><constraints nullable="false"/></column>
			<column name="item_id" type="int"><constraints nullable="false"/></column>
			<column name="quantity" type="int"><constraints nullable="false"/></column>

			<column name="batch_operation_id" type="int"/>
			<column name="calculated_batch" type="boolean" defaultValueBoolean="true" />

			<column name="expiration" type="DATE"/>
			<column name="calculated_expiration" type="boolean" defaultValueBoolean="true" />

			<column name="uuid" type="char(38)"><constraints nullable="false" unique="true"/></column>
		</createTable>

		<addForeignKeyConstraint constraintName="inv_stock_operation_item_stock_op_fk"
								 baseTableName="inv_stock_operation_item" baseColumnNames="operation_id"
								 referencedTableName="inv_stock_operation" referencedColumnNames="stock_operation_id"/>
		<addForeignKeyConstraint constraintName="inv_stock_operation_item_item_fk"
								 baseTableName="inv_stock_operation_item" baseColumnNames="item_id"
								 referencedTableName="inv_item" referencedColumnNames="item_id"/>
		<addForeignKeyConstraint constraintName="inv_stock_operation_item_batch_fk"
								 baseTableName="inv_stock_operation_item" baseColumnNames="batch_operation_id"
								 referencedTableName="inv_stock_operation" referencedColumnNames="stock_operation_id"/>
	</changeSet>
	<changeSet id="openhmis.inventory-v1.0.0-11" author="marios">
		<addNotNullConstraint
            columnDataType="varchar(255)"
            columnName="operation_number"
            tableName="inv_stock_operation"/>
	</changeSet>
	<changeSet id="openhmis.inventory-v1.2.0-1" author="ibewes">
		<addColumn tableName="inv_stock_operation">
			<column name="department_id" type="int"><constraints nullable="true" /></column>
		</addColumn>

		<addForeignKeyConstraint constraintName="inv_stock_operation_department_fk"
								 baseTableName="inv_stock_operation" baseColumnNames="department_id"
								 referencedTableName="inv_department" referencedColumnNames="department_id"/>
	</changeSet>
	<changeSet id="openhmis.inventory-v1.2.0-2" author="ibewes">
		<addColumn tableName="inv_item">
			<column name="minimum_quantity" type="int"><constraints nullable="true" /></column>
		</addColumn>
	</changeSet>
	<changeSet id="openhmis.inventory-v1.3.0-1" author="ibewes">
		<addColumn tableName="inv_item">
			<column name="buying_price" type="DECIMAL(10,2)"><constraints nullable="true" /></column>
		</addColumn>
	</changeSet>
	<changeSet id="openhmis.inventory-v1.3.0-2" author="ibewes">
		<insert tableName="inv_stock_operation_type">
			<column name="name">Initial</column>
			<column name="operation_type">initial</column>
			<column name="description">The initial stockroom item stock quantities.</column>
			<column name="has_source">0</column>
			<column name="has_destination">1</column>
			<column name="has_recipient">0</column>
			<column name="recipient_required">0</column>
			<column name="available_when_reserved">0</column>
			<column name="creator">1</column>
			<column name="date_created">2013-01-01</column>
			<column name="uuid">20f3734f-5b1a-490d-8676-1225a9cdddf7</column>
		</insert>
	</changeSet>
	<changeSet id="openhmis.inventory-v1.3.0-3" author="ibewes">
		<addColumn tableName="inv_stock_operation">
			<column name="operation_order" type="int"><constraints nullable="true"/></column>
		</addColumn>

		<sql>
			SET @counter := 0;
			UPDATE inv_stock_operation SET operation_order = (SELECT @counter := @counter + 1) ORDER BY operation_date ASC;
		</sql>
	</changeSet>
	<changeSet id="openhmis.inventory-v1.5.0-1" author="marios">
		<dropForeignKeyConstraint baseTableName="inv_item" constraintName="inv_item_category_fk" />
		<dropForeignKeyConstraint baseTableName="inv_category" constraintName="inv_category_creator_fk" />
		<dropForeignKeyConstraint baseTableName="inv_category" constraintName="inv_category_changed_by_fk" />
		<dropForeignKeyConstraint baseTableName="inv_category" constraintName="inv_category_parent_fk" />
		<dropColumn  columnName="category_id" tableName="inv_item"/>
		<dropTable tableName="inv_category" />
	</changeSet>
    <changeSet id="openhmis.inventory-v1.5.0-2" author="Stephen Kinyori">
		<comment>Adding the column "cancel_reason" to the table inv_stock_operation</comment>
		<addColumn tableName="inv_stock_operation">
			<column name="cancel_reason" type="varchar(500)"><constraints nullable="true"/></column>
		</addColumn>
	</changeSet>
	<changeSet id="openhmis.inventory-v1.5.0-3" author="ibewes">
		<dropTable tableName="inv_item_attribute" />
		<dropTable tableName="inv_item_attribute_type" />

		<createTable tableName="inv_item_attribute_type">
			<column name="item_attribute_type_id" type="int" autoIncrement="true">
				<constraints primaryKey="true" nullable="false" />
			</column>

			<column name="name" type="varchar(255)"><constraints nullable="false" /></column>
			<column name="description" type="varchar(1024)" />
			<column name="attribute_order" type="int"><constraints nullable="false"/></column>
			<column name="foreignKey" type="int" />
			<column name="format" type="varchar(255)" />
			<column name="reg_exp" type="varchar(255)" />
			<column name="required" type="BOOLEAN" defaultValueBoolean="false" />

			<column name="creator" type="int"><constraints nullable="false" /></column>
			<column name="date_created" type="datetime"><constraints nullable="false" /></column>
			<column name="changed_by" type="int" />
			<column name="date_changed" type="datetime" />
			<column name="retired" type="boolean" defaultValueBoolean="false"><constraints nullable="false" /></column>
			<column name="retired_by" type="int" />
			<column name="date_retired" type="datetime" />
			<column name="retire_reason" type="varchar(255)" defaultValue="null" />

			<column name="uuid" type="char(38)"><constraints nullable="false" unique="true" /></column>
		</createTable>
		<createTable tableName="inv_item_attribute">
			<column name="item_attribute_id" type="int" autoIncrement="true">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="item_id" type="int"><constraints nullable="false" /></column>
			<column name="item_attribute_type_id" type="int"><constraints nullable="false" /></column>
			<column name="value_reference" type="text"><constraints nullable="false" /></column>

			<column name="creator" type="int"><constraints nullable="false" /></column>
			<column name="date_created" type="datetime"><constraints nullable="false" /></column>
			<column name="changed_by" type="int" />
			<column name="date_changed" type="datetime" />
			<column name="retired" type="boolean" defaultValueBoolean="false"><constraints nullable="false" /></column>
			<column name="retired_by" type="int" />
			<column name="date_retired" type="datetime" />
			<column name="retire_reason" type="varchar(255)" defaultValue="null" />

			<column name="uuid" type="char(38)"><constraints nullable="false" unique="true" /></column>
		</createTable>

		<addForeignKeyConstraint constraintName="inv_item_attribute_type_creator_fk"
								 baseTableName="inv_item_attribute_type" baseColumnNames="creator"
								 referencedTableName="users" referencedColumnNames="user_id"/>
		<addForeignKeyConstraint constraintName="inv_item_attribute_type_changed_by_fk"
								 baseTableName="inv_item_attribute_type" baseColumnNames="changed_by"
								 referencedTableName="users" referencedColumnNames="user_id"/>
		<addForeignKeyConstraint constraintName="cinv_item_attribute_type_retired_by_fk"
								 baseTableName="inv_item_attribute_type" baseColumnNames="retired_by"
								 referencedTableName="users" referencedColumnNames="user_id"/>

		<addForeignKeyConstraint constraintName="inv_item_attribute_item_id_fk"
								 baseTableName="inv_item_attribute" baseColumnNames="item_id"
								 referencedTableName="inv_item" referencedColumnNames="item_id"
								 onDelete="CASCADE" onUpdate="CASCADE"/>
		<addForeignKeyConstraint constraintName="inv_item_attribute_inv_item_attribute_type_id_fk"
								 baseTableName="inv_item_attribute" baseColumnNames="item_attribute_type_id"
								 referencedTableName="inv_item_attribute_type" referencedColumnNames="item_attribute_type_id"/>
	</changeSet>
	<changeSet id="openhmis.inventory-v1.5.0-4" author="ibewes">
		<comment>
			Update any incorrectly defined expiration dates that include a time portion. This will take into account the
			timezone for the server.
		</comment>
		<sql><![CDATA[
			UPDATE inv_item_stock_detail
			SET expiration = ADDTIME(expiration, timediff(now(),convert_tz(now(),@@session.time_zone,'+00:00')))
			WHERE TIME(expiration) > 0 AND expiration IS NOT NULL;
		]]></sql>

		<comment>
			Update any detail records that are now duplicated (that is have the same stockroom, item, expiration, and batch).
		</comment>
		<sql><![CDATA[
			UPDATE inv_item_stock_detail Z INNER JOIN
					(SELECT A.item_stock_detail_id, SUM(B.quantity) AS sum_quantity
					 FROM inv_item_stock_detail A INNER JOIN inv_item_stock_detail B ON
						A.item_stock_detail_id < B.item_stock_detail_id AND
						A.item_id = B.item_id AND A.stockroom_id = B.stockroom_id AND
						A.expiration = B.expiration AND A.batch_operation_id = B.batch_operation_id
					 WHERE A.item_stock_detail_id = (SELECT MIN(item_stock_detail_id)
													 FROM inv_item_stock_detail
													 WHERE item_id = A.item_id AND stockroom_id = A.stockroom_id AND
														expiration = A.expiration AND
														batch_operation_id = A.batch_operation_id)
					 GROUP BY A.item_id, A.item_stock_detail_id, A.quantity) CALC ON
				Z.item_stock_detail_id = CALC.item_stock_detail_id
			SET Z.quantity = Z.quantity + CALC.sum_quantity;
		]]></sql>

		<comment>
			Delete the duplicated records, leaving the only record that was updated.
		</comment>
		<sql><![CDATA[
			DELETE A
			FROM inv_item_stock_detail AS A INNER JOIN inv_item_stock_detail AS B ON
				A.item_stock_detail_id > B.item_stock_detail_id AND
				A.item_id = B.item_id AND A.stockroom_id = B.stockroom_id AND
				A.expiration = B.expiration AND A.batch_operation_id = B.batch_operation_id;
		]]></sql>

		<comment>
			Update operation items and transactions to add a single day if the timezone would have cause the date to be
			one day in the past
		</comment>
		<sql><![CDATA[
			UPDATE inv_stock_operation_item
			SET expiration = DATE_ADD(expiration, INTERVAL 1 DAY)
			WHERE expiration IS NOT NULL AND timediff(now(),convert_tz(now(),@@session.time_zone,'+00:00')) > 0;

			UPDATE inv_transaction
			SET expiration = DATE_ADD(expiration, INTERVAL 1 DAY)
			WHERE expiration IS NOT NULL AND timediff(now(),convert_tz(now(),@@session.time_zone,'+00:00')) > 0;
		]]></sql>

		<comment>
			Finally, update the inv_item_stock_detail.expiration column to be only a DATE column, not DATETIME
		</comment>
		<modifyColumn tableName="inv_item_stock_detail">
			<column name="expiration" type="DATE"><constraints nullable="true"/></column>
		</modifyColumn>

		<comment>
			Remove any invalid reservation transactions that are hanging around.
		</comment>
		<sql><![CDATA[
			DELETE trans
			FROM inv_stock_operation op INNER JOIN inv_reserved_transaction trans ON
				op.stock_operation_id = trans.operation_id
			WHERE op.status = 'COMPLETED'
		]]></sql>
	</changeSet>
	<changeSet id="openhmis.inventory-v1.7.0-0" author="marios">
		<dropNotNullConstraint
			columnDataType="varchar(255)"
			columnName="attribute_order"
			tableName="inv_item_attribute_type"/>
	</changeSet>
</databaseChangeLog>
